---
- name: Install Java and Tomcat
  hosts: all  # This is defined at the playbook level, not at the task level
  become: true
  tasks:
    - name: Install Java 1.7
      yum:
        name: java-1.7.0-openjdk
        state: present

    - name: Add group "tomcat"
      group:
        name: tomcat

    - name: Add user "tomcat"
      user:
        name: tomcat
        group: tomcat
        home: /usr/share/tomcat
        create_home: no

    - name: Download Tomcat
      get_url:
        url: http://archive.apache.org/dist/tomcat/tomcat-7/v7.0.61/bin/apache-tomcat-7.0.61.tar.gz
        dest: /opt/apache-tomcat-7.0.61.tar.gz

    - name: Extract archive
      command:
        cmd: /bin/tar xvf /opt/apache-tomcat-7.0.61.tar.gz -C /opt/
        chdir: /usr/share
        creates: /opt/apache-tomcat-7.0.61

    - name: Install symlink
      file:
        src: /opt/apache-tomcat-7.0.61
        dest: /usr/share/tomcat
        state: link

    - name: Configure Tomcat server
      template:
        src: server.xml
        dest: /usr/share/tomcat/conf/server.xml
      notify: restart tomcat

    - name: Install Tomcat init script
      copy:
        src: tomcat-initscript.sh
        dest: /etc/init.d/tomcat
        mode: '0755'

    - name: Start and enable Tomcat service
      service:
        name: tomcat
        state: started
        enabled: yes

    - name: Wait for Tomcat to start
      wait_for:
        port: "{{ http_port }}"
        state: started
        timeout: 30

  handlers:
    - name: restart tomcat
      service:
        name: tomcat
        state: restarted
